<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Email Agent - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            gap: 0.5rem;
        }

        .logo-icon {
            font-size: 2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
            font-weight: 500;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* Main Layout */
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 100px);
        }

        /* Sidebar Navigation */
        .sidebar {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 120px;
        }

        .sidebar h3 {
            margin-bottom: 1.5rem;
            color: #667eea;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            color: #666;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover, .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        /* Main Content Area */
        .main-content {
            display: grid;
            gap: 2rem;
        }

        /* Quick Stats Section */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            font-size: 2rem;
            padding: 0.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #333;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #28a745;
            margin-top: 0.5rem;
        }

        /* Content Sections */
        .content-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-title {
            font-size: 1.8rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-subtitle {
            color: #666;
            margin-top: 0.5rem;
            font-size: 0.95rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .quick-action {
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .quick-action::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .quick-action:hover::before {
            left: 100%;
        }

        .quick-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .quick-action-icon {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        /* Response Areas */
        .response-area {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 1.5rem;
            min-height: 150px;
            font-family: inherit;
            margin: 1rem 0;
            line-height: 1.6;
            position: relative;
        }

        .response-area.loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            animation: loading-bar 2s infinite;
        }

        @keyframes loading-bar {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Checkbox styling */
        .email-checkbox, #select-all-emails {
            transform: scale(1.2);
            accent-color: #667eea;
            cursor: pointer;
        }
        
        /* Email List */
        .email-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            margin: 1rem 0;
            background: white;
        }

        .email-item {
            padding: 1rem;
            border-bottom: 1px solid #e1e5e9;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .email-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .email-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #667eea;
        }

        .email-item.unread {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), rgba(255, 165, 0, 0.05));
            border-left: 3px solid #ffa500;
        }

        .email-subject {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #333;
        }

        .email-from {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 0.5rem;
            font-weight: 500; 
        }

        .email-preview {
            font-size: 0.85rem;
            color: #555;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .email-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
        }
        /* Move button styling */
        #move-selected-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #move-selected-btn:not(:disabled):hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        /* Controls section styling */
        #email-controls {
            border: 1px solid #e1e5e9;
        }
        
            /* Meeting Form */
        .meeting-form {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 2rem;
            margin: 1rem 0;
            display: none;
        }

        .meeting-form.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Selected count styling */
        #selected-count {
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        /* Logout Button */
        .logout-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 250px 1fr;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #email-controls {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }
    
            #email-controls > div {
                justify-content: center;
            }
        }
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 1rem;
            }
            
            .sidebar {
                position: static;
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .stats-section {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .content-section {
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .dashboard-container {
                padding: 0.5rem;
            }
            
            .content-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem;
            }
            
            .quick-action {
                padding: 1rem;
            }
            /* 6. ADD this new CSS to improve section titles */
            .card h2 {
                margin-bottom: 1rem;
                color: #333; /* Ensure dark text */
                border-bottom: 2px solid #667eea;
                padding-bottom: 0.5rem;
                font-weight: 600; /* Make titles bolder */
            }
            
            /* 7. ADD this to improve form labels */
            input[type="text"], input[type="email"], input[type="datetime-local"], select, textarea {
                flex: 1;
                padding: 12px;
                border: 2px solid #e1e5e9;
                border-radius: 8px;
                font-size: 1rem;
                color: #333; /* Ensure dark text in form fields */
                background: white; /* Ensure white background */
            }
            
            /* 8. ADD this to improve response area text */
            .response-area {
                background: #f8f9fa;
                border: 1px solid #e1e5e9;
                border-radius: 8px;
                padding: 1rem;
                min-height: 150px;
                font-family: inherit;
                margin-bottom: 1rem;
                line-height: 1.6;
                color: #333; /* Ensure dark text */
            }
            
            /* 9. ADD this to improve loading text visibility */
            .loading {
                text-align: center;
                color: #333; /* Change from #6c757d to #333 */
                font-style: italic;
                font-weight: 500;
            }

            /* Signature Settings Specific Styles */
            .signature-settings {
                background: #f8f9ff;
                border: 1px solid #e1e5e9;
                border-radius: 12px;
                padding: 1.5rem;
                margin: 1rem 0;
            }
            
            .signature-preview {
                background: white;
                border: 2px solid #e1e5e9;
                border-radius: 8px;
                padding: 1rem;
                margin: 1rem 0;
                font-family: Arial, sans-serif;
                font-size: 0.9rem;
                line-height: 1.5;
                min-height: 120px;
                position: relative;
            }
            
            .signature-preview::before {
                content: "Email Signature Preview";
                position: absolute;
                top: -10px;
                left: 15px;
                background: white;
                padding: 0 8px;
                font-size: 0.75rem;
                color: #667eea;
                font-weight: 600;
            }
            
            .signature-preview.empty {
                display: flex;
                align-items: center;
                justify-content: center;
                color: #999;
                font-style: italic;
            }
            
            /* Form styling for signature inputs */
            .form-input, .form-textarea {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid #e1e5e9;
                border-radius: 8px;
                font-size: 0.9rem;
                transition: border-color 0.3s ease, box-shadow 0.3s ease;
            }
            
            .form-input:focus, .form-textarea:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
            
            .form-label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 500;
                color: #333;
                font-size: 0.9rem;
            }
            
            /* Checkbox styling */
            .signature-checkbox {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.75rem;
                background: #f8f9fa;
                border-radius: 8px;
                border: 1px solid #e1e5e9;
                margin: 1rem 0;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }
            
            .signature-checkbox:hover {
                background: #e9ecef;
            }
            
            .signature-checkbox input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
            }
            
            /* Success message for signature */
            .signature-success {
                background: #d4edda;
                color: #155724;
                padding: 0.75rem 1rem;
                border-radius: 8px;
                border: 1px solid #c3e6cb;
                margin: 1rem 0;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            /* Settings section headers */
            .settings-section-header {
                border-bottom: 2px solid #667eea;
                padding-bottom: 0.5rem;
                margin-bottom: 1.5rem;
            }
            
            .settings-section-header h3 {
                color: #667eea;
                margin: 0;
                font-size: 1.1rem;
                font-weight: 600;
            }
            
            .settings-section-header p {
                color: #666;
                margin: 0.5rem 0 0 0;
                font-size: 0.85rem;
                line-height: 1.4;
            }
            
            /* Responsive adjustments for signature settings */
            @media (max-width: 768px) {
                .signature-settings {
                    padding: 1rem;
                    margin: 0.5rem 0;
                }
                
                .signature-preview {
                    padding: 0.75rem;
                    font-size: 0.85rem;
                }
                
                .form-input, .form-textarea {
                    padding: 0.6rem;
                    font-size: 0.85rem;
                }
            }
            
            /* Animation for signature preview updates */
            .signature-preview-updating {
                opacity: 0.7;
                transform: scale(0.98);
                transition: opacity 0.2s ease, transform 0.2s ease;
            }
            
            /* Signature field icons */
            .signature-field-icon {
                display: inline-block;
                width: 20px;
                margin-right: 0.5rem;
                text-align: center;
            }
            
            /* Save button enhancement for signature */
            .btn-save-signature {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 8px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .btn-save-signature:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }
        }

                /* Enhanced Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                color: #ffffff;
            }
            
            .sidebar, .content-section, .stat-card {
                background: #2a2a2a;
                color: #ffffff;
                border: 1px solid #4a4a4a;
            }
            
            /* Input fields - properly scoped to dark mode only */
            .form-input, .form-select, .form-textarea {
                background: #3a3a3a;
                border-color: #667eea;
                color: #ffffff;
            }
            
            .form-input::placeholder,
            .form-select::placeholder, 
            .form-textarea::placeholder {
                color: #cccccc;
                opacity: 1;
            }
            
            /* Response areas - properly scoped */
            .response-area {
                background: #3a3a3a;
                border-color: #667eea;
                color: #ffffff;
            }
            
            /* All text inside response areas */
            .response-area *,
            .response-area h1, 
            .response-area h2, 
            .response-area h3, 
            .response-area h4, 
            .response-area h5, 
            .response-area h6,
            .response-area p,
            .response-area div,
            .response-area span,
            .response-area li,
            .response-area strong,
            .response-area em {
                color: #ffffff;
            }
            
            .form-label {
                color: #ffffff;
            }
            
            .section-title {
                color: #ffffff;
            }
            
            .section-subtitle {
                color: #cccccc;
            }
            
            .email-subject, .email-from, .email-preview, .email-meta {
                color: #ffffff;
            }
            
            .email-list {
                background: #2a2a2a;
                border-color: #4a4a4a;
            }
            
            .email-item {
                background: #2a2a2a;
                border-bottom: 1px solid #4a4a4a;
                color: #ffffff;
            }
            
            .email-item:hover {
                background: #3a3a3a;
            }
            
            .stat-value {
                color: #ffffff;
            }
            
            .stat-label {
                color: #ffffff;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <span class="logo-icon">🤖📧</span>
            <span>AI Email Agent</span>
        </div>
        <div class="user-info">
            <div class="user-avatar">👤</div>
            <span id="user-name">Loading...</span>
            <a href="/auth/logout" class="logout-btn">Logout</a>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <h3>Navigation</h3>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="showSection('overview')">
                        <span class="nav-icon">📊</span>
                        <span>Overview</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('email-analyzer')">
                        <span class="nav-icon">🔍</span>
                        <span>Email Analyzer</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('email-responder')">
                        <span class="nav-icon">✍️</span>
                        <span>Email Responder</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('calendar-manager')">
                        <span class="nav-icon">📅</span>
                        <span>Calendar Manager</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('ai-assistant')">
                        <span class="nav-icon">🤖</span>
                        <span>AI Assistant</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('settings')">
                        <span class="nav-icon">⚙️</span>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Quick Stats -->
            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">📧</div>
                    </div>
                    <div class="stat-value" id="total-emails">-</div>
                    <div class="stat-label">Total Emails Today</div>
                    <div class="stat-trend">
                        <span>📈</span>
                        <span>+12% from yesterday</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">📬</div>
                    </div>
                    <div class="stat-value" id="unread-emails">-</div>
                    <div class="stat-label">Unread Emails</div>
                    <div class="stat-trend">
                        <span>📉</span>
                        <span>-5% from yesterday</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">📅</div>
                    </div>
                    <div class="stat-value" id="today-meetings">-</div>
                    <div class="stat-label">Today's Meetings</div>
                    <div class="stat-trend">
                        <span>📊</span>
                        <span>3 upcoming</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">🎯</div>
                    </div>
                    <div class="stat-value">85%</div>
                    <div class="stat-label">Productivity Score</div>
                    <div class="stat-trend">
                        <span>📈</span>
                        <span>+8% this week</span>
                    </div>
                </div>
            </div>

            <!-- Overview Section -->
            <div id="overview-section" class="content-section active">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>📊</span>
                            Dashboard Overview
                        </h2>
                        <p class="section-subtitle">Your AI-powered email and calendar insights at a glance</p>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action" onclick="quickQuery('Summarize my emails from today')">
                        <span class="quick-action-icon">📊</span>
                        Today's Email Summary
                    </button>
                    <button class="quick-action" onclick="loadTodaySchedule()">
                        <span class="quick-action-icon">📅</span>
                        Today's Schedule
                    </button>
                    <button class="quick-action" onclick="quickQuery('Show me my unread emails')">
                        <span class="quick-action-icon">📬</span>
                        Unread Messages
                    </button>
                    <button class="quick-action" onclick="checkTomorrowAvailability()">
                        <span class="quick-action-icon">🕒</span>
                        Tomorrow's Availability
                    </button>
                </div>

                <div class="response-area" id="overview-response">
                    Welcome to your AI Email Agent dashboard! 🚀
                    
                    <br><br><strong>Quick Start Guide:</strong>
                    <br>• Use the <strong>Email Analyzer</strong> to get intelligent insights about your messages
                    <br>• Try the <strong>Email Responder</strong> to generate AI-powered replies
                    <br>• Manage your schedule with the <strong>Calendar Manager</strong>
                    <br>• Ask questions to your <strong>AI Assistant</strong> for personalized help
                    
                    <br><br><em>Click any quick action above to get started!</em>
                </div>
            </div>

            <!-- Email Analyzer Section -->
            <div id="email-analyzer-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>🔍</span>
                            Email Analyzer
                        </h2>
                        <p class="section-subtitle">Ask intelligent questions about your emails and get AI-powered insights</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ask about your emails:</label>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" class="form-input" id="analyzer-query" 
                               placeholder="e.g., 'Show me emails about the project deadline'" 
                               style="flex: 1;">
                        <button class="btn btn-primary" onclick="analyzeEmails()">
                            <span>🔍</span>
                            Analyze
                        </button>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action" onclick="quickAnalyze('Summarize my emails from today')">
                        <span class="quick-action-icon">📊</span>
                        Daily Summary
                    </button>
                    <button class="quick-action" onclick="quickAnalyze('Find urgent emails')">
                        <span class="quick-action-icon">🚨</span>
                        Urgent Messages
                    </button>
                    <button class="quick-action" onclick="quickAnalyze('Show me emails with attachments')">
                        <span class="quick-action-icon">📎</span>
                        With Attachments
                    </button>
                    <button class="quick-action" onclick="quickAnalyze('Find meeting invitations')">
                        <span class="quick-action-icon">📅</span>
                        Meeting Invites
                    </button>
                </div>

                <div class="response-area" id="analyzer-response">
                    Enter a question about your emails above to get AI-powered insights and analysis.
                </div>
            </div>

            <!-- Email Responder Section -->
            <div id="email-responder-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>✍️</span>
                            Email Responder
                        </h2>
                        <p class="section-subtitle">Generate professional AI-powered email responses</p>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="loadEmailsForResponse()" style="margin-bottom: 2rem;">
                    <span>📧</span>
                    Load Recent Emails
                </button>

                <div id="email-list-container" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Select an email to respond to:</h3>
                    <div id="email-list" class="email-list"></div>
                </div>

                <div id="response-form" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Generate Response</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Additional Context:</label>
                        <textarea class="form-textarea" id="response-context" 
                                  placeholder="Any additional context or specific points you want to address..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Response Tone:</label>
                        <select class="form-select" id="response-tone">
                            <option value="professional">Professional</option>
                            <option value="friendly">Friendly</option>
                            <option value="formal">Formal</option>
                            <option value="casual">Casual</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                        <button class="btn btn-primary" onclick="generateResponse()">
                            <span>🤖</span>
                            Generate Response
                        </button>
                        <button class="btn btn-outline" onclick="cancelResponse()">
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="response-preview" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Generated Response</h3>
                    <div id="response-content" class="response-area"></div>
                   <div id="send-buttons" style="display: none; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="sendResponse(false)" style="margin-right: 1rem;">
                            <span>📤</span>
                            Send Reply
                        </button>
                        <button class="btn btn-outline" onclick="sendResponse(true)">
                            <span>📧</span>
                            Reply to All
                        </button>
                        <button class="btn btn-outline" onclick="document.getElementById('response-preview').style.display='none'; document.getElementById('send-buttons').style.display='none';" 
                                style="margin-left: 1rem; background: #f8f9fa; color: #666;">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendar Manager Section -->
            <div id="calendar-manager-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>📅</span>
                            Calendar Manager
                        </h2>
                        <p class="section-subtitle">Intelligent calendar analysis and meeting scheduling</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Calendar Query:</label>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" class="form-input" id="calendar-query" 
                               placeholder="e.g., 'Schedule a team meeting next week'" 
                               style="flex: 1;">
                        <button class="btn btn-primary" onclick="analyzeCalendar()">
                            <span>📅</span>
                            Analyze
                        </button>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action" onclick="quickCalendar('Analyze my schedule for conflicts this week')">
                        <span class="quick-action-icon">🔍</span>
                        Find Conflicts
                    </button>
                    <button class="quick-action" onclick="quickCalendar('Best time for a 1-hour team meeting next week')">
                        <span class="quick-action-icon">👥</span>
                        Schedule Meeting
                    </button>
                    <button class="quick-action" onclick="quickCalendar('Show me my availability for client calls')">
                        <span class="quick-action-icon">📞</span>
                        Client Availability
                    </button>
                    <button class="quick-action" onclick="showMeetingForm()">
                        <span class="quick-action-icon">➕</span>
                        Create Meeting
                    </button>
                </div>

                <div class="response-area" id="calendar-response">
                    Ask questions about your calendar or use the quick actions above to get started.
                </div>

                <div id="meeting-form" class="meeting-form">
                    <h3 style="margin-bottom: 1.5rem;">Create Meeting Invite</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Meeting Title:</label>
                        <input type="text" class="form-input" id="meeting-title" placeholder="Enter meeting subject">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Time:</label>
                            <input type="datetime-local" class="form-input" id="meeting-start">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Time:</label>
                            <input type="datetime-local" class="form-input" id="meeting-end">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Attendees (comma-separated emails):</label>
                        <input type="text" class="form-input" id="meeting-attendees" 
                               placeholder="email1@company.com, email2@company.com">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Meeting Type:</label>
                            <select class="form-select" id="meeting-type">
                                <option value="teams">Microsoft Teams</option>
                                <option value="zoom">Zoom Meeting</option>
                                <option value="in-person">In-Person</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location:</label>
                            <input type="text" class="form-input" id="meeting-location" 
                                   placeholder="Conference Room or Meeting Link">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Agenda:</label>
                        <textarea class="form-textarea" id="meeting-agenda" 
                                  placeholder="Meeting agenda and objectives..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-success" onclick="createMeeting()">
                            <span>📅</span>
                            Create Meeting
                        </button>
                        <button class="btn btn-outline" onclick="hideMeetingForm()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Assistant Section -->
            <div id="ai-assistant-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>🤖</span>
                            AI Assistant
                        </h2>
                        <p class="section-subtitle">Your personal AI assistant for email and calendar management</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ask your AI assistant:</label>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" class="form-input" id="ai-query" 
                               placeholder="Ask anything about your emails, calendar, or productivity..." 
                               style="flex: 1;">
                        <button class="btn btn-primary" onclick="askAI()">
                            <span>🤖</span>
                            Ask AI
                        </button>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-action" onclick="quickAI('What should I focus on today?')">
                        <span class="quick-action-icon">🎯</span>
                        Daily Focus
                    </button>
                    <button class="quick-action" onclick="quickAI('Help me prioritize my tasks')">
                        <span class="quick-action-icon">📋</span>
                        Prioritize Tasks
                    </button>
                    <button class="quick-action" onclick="quickAI('Suggest time blocks for deep work')">
                        <span class="quick-action-icon">⏰</span>
                        Time Blocking
                    </button>
                    <button class="quick-action" onclick="quickAI('How can I improve my email productivity?')">
                        <span class="quick-action-icon">📈</span>
                        Productivity Tips
                    </button>
                </div>

                <div class="response-area" id="ai-response">
                    Hi! I'm your AI assistant. Ask me anything about your emails, calendar, or how to improve your productivity. I can help you:
                    
                    <br><br>• Analyze your email patterns and suggest improvements
                    <br>• Find optimal times for meetings and focused work
                    <br>• Prioritize your tasks based on your schedule
                    <br>• Generate professional email responses
                    <br>• Detect meeting opportunities in your conversations
                    
                    <br><br>What would you like help with today?
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">
                            <span>⚙️</span>
                            Settings
                        </h2>
                        <p class="section-subtitle">Customize your AI Email Agent experience</p>
                    </div>
                </div>

                <div style="display: grid; gap: 2rem;">
                    <div>
                        <h3 style="margin-bottom: 1rem; color: #667eea;">AI Response Preferences</h3>
                        <div class="form-group">
                            <label class="form-label">Default Response Tone:</label>
                            <select class="form-select" id="default-tone">
                                <option value="professional">Professional</option>
                                <option value="friendly">Friendly</option>
                                <option value="formal">Formal</option>
                                <option value="casual">Casual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Summary Frequency:</label>
                            <select class="form-select" id="summary-frequency">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="manual">Manual Only</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 1rem; color: #667eea;">Calendar Preferences</h3>
                        <div class="form-group">
                            <label class="form-label">Default Meeting Duration:</label>
                            <select class="form-select" id="default-duration">
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="90">1.5 hours</option>
                                <option value="120">2 hours</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Meeting Type:</label>
                            <select class="form-select" id="preferred-meeting-type">
                                <option value="teams">Microsoft Teams</option>
                                <option value="zoom">Zoom</option>
                                <option value="in-person">In-Person</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 1rem; color: #667eea;">Notification Settings</h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" checked> Email summary notifications
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" checked> Meeting conflict alerts
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox"> Weekly productivity reports
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #f0f0f0;">
                        <h3 style="margin-bottom: 1rem; color: #667eea;">Email Signature Settings</h3>
                        <p style="color: #666; margin-bottom: 1.5rem; font-size: 0.9rem;">
                            Configure your email signature that will be automatically included in all AI-generated email responses.
                        </p>
                        
                        <div class="form-group">
                            <label class="form-label">Full Name:</label>
                            <input type="text" class="form-input" id="signature-name" 
                                   placeholder="e.g., John Smith">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Job Title:</label>
                            <input type="text" class="form-input" id="signature-title" 
                                   placeholder="e.g., Senior Marketing Manager">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Company:</label>
                            <input type="text" class="form-input" id="signature-company" 
                                   placeholder="e.g., ABC Corporation">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Phone Number:</label>
                            <input type="text" class="form-input" id="signature-phone" 
                                   placeholder="e.g., (555) 123-4567">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email Address:</label>
                            <input type="email" class="form-input" id="signature-email" 
                                   placeholder="e.g., john.smith@company.com">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Website (optional):</label>
                            <input type="url" class="form-input" id="signature-website" 
                                   placeholder="e.g., https://www.company.com">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Additional Information (optional):</label>
                            <textarea class="form-textarea" id="signature-additional" 
                                      placeholder="e.g., Department, Location, or other contact details..." 
                                      rows="2"></textarea>
                        </div>
                        
                        <div style="margin: 1.5rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e1e5e9;">
                            <h4 style="margin-bottom: 0.5rem; color: #333; font-size: 0.9rem;">Preview:</h4>
                            <div id="signature-preview" style="font-family: Arial, sans-serif; font-size: 0.85rem; line-height: 1.4; color: #666; border-left: 3px solid #667eea; padding-left: 1rem;">
                                <em>Your signature preview will appear here...</em>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="signature-enabled" checked> 
                                <span style="font-weight: 500;">Include signature in AI email responses</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="padding-top: 2rem; border-top: 2px solid #f0f0f0;">
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <span>💾</span>
                            Save Settings
                        </button>
                        <button class="btn btn-outline" onclick="resetSettings()" style="margin-left: 1rem;">
                            Reset to Defaults
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let selectedEmailId = null;
        let generatedResponse = null;

        // Initialize dashboard
        window.onload = function() {
            loadUserInfo();
            loadStats();
            showSection('overview');
        };

        // Navigation functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // Add active class to corresponding nav link
            event.target.closest('.nav-link').classList.add('active');
        }

        // Load user information
        async function loadUserInfo() {
            try {
                const response = await fetch('/auth/user');
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('user-name').textContent = data.user.name || data.user.username;
                } else {
                    window.location.href = '/auth/login';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                document.getElementById('user-name').textContent = 'Error loading user';
            }
        }

        // REPLACE your existing loadStats() function in dashboard.html with this enhanced version:

async function loadStats() {
    try {
        console.log('📊 Loading dashboard statistics...');
        
        // Load email stats
        const emailResponse = await fetch('/api/emails?days=1');
        if (emailResponse.ok) {
            const emailData = await emailResponse.json();
            const unreadCount = emailData.emails.filter(email => !email.isRead).length;
            
            document.getElementById('total-emails').textContent = emailData.count;
            document.getElementById('unread-emails').textContent = unreadCount;
            
            console.log('📧 Email stats:', { total: emailData.count, unread: unreadCount });
        }

        // Load calendar stats
        const calendarResponse = await fetch('/api/calendar/today');
        if (calendarResponse.ok) {
            const calendarData = await calendarResponse.json();
            document.getElementById('today-meetings').textContent = calendarData.eventCount || 0;
            
            console.log('📅 Calendar stats:', { meetings: calendarData.eventCount });
        }

        // Calculate and update productivity score
        await calculateProductivityScore();
        
    } catch (error) {
        console.error('Error loading stats:', error);
        // Set fallback values if API calls fail
        document.getElementById('total-emails').textContent = '-';
        document.getElementById('unread-emails').textContent = '-';
        document.getElementById('today-meetings').textContent = '-';
    }
}

// NEW: Calculate actual productivity score based on email and calendar metrics
async function calculateProductivityScore() {
    try {
        console.log('🎯 Calculating productivity score...');
        
        // Get extended email data for productivity calculation
        const [emailToday, emailWeek, calendarWeek] = await Promise.all([
            fetch('/api/emails?days=1').then(r => r.json()),
            fetch('/api/emails?days=7').then(r => r.json()),
            fetch('/api/calendar/events?days=7').then(r => r.json())
        ]);

        let score = 50; // Base score
        let factors = [];

        if (emailToday.success && emailWeek.success) {
            // Email responsiveness factor (40% of score)
            const todayUnread = emailToday.emails.filter(e => !e.isRead).length;
            const weeklyTotal = emailWeek.count;
            const responseRate = weeklyTotal > 0 ? ((weeklyTotal - todayUnread) / weeklyTotal) * 100 : 100;
            
            if (responseRate >= 90) {
                score += 20;
                factors.push('📧 Excellent email responsiveness (+20)');
            } else if (responseRate >= 70) {
                score += 15;
                factors.push('📧 Good email responsiveness (+15)');
            } else if (responseRate >= 50) {
                score += 10;
                factors.push('📧 Fair email responsiveness (+10)');
            } else {
                score += 5;
                factors.push('📧 Needs improvement in email responsiveness (+5)');
            }

            // Email volume management (20% of score)
            const dailyAverage = weeklyTotal / 7;
            if (dailyAverage <= 10) {
                score += 15;
                factors.push('📈 Great email volume management (+15)');
            } else if (dailyAverage <= 20) {
                score += 10;
                factors.push('📈 Good email volume (+10)');
            } else if (dailyAverage <= 30) {
                score += 5;
                factors.push('📈 Moderate email volume (+5)');
            } else {
                factors.push('📈 High email volume (no bonus)');
            }
        }

        if (calendarWeek.success) {
            // Calendar optimization factor (30% of score)
            const weeklyMeetings = calendarWeek.count;
            const dailyMeetingAverage = weeklyMeetings / 7;
            
            if (dailyMeetingAverage <= 3) {
                score += 15;
                factors.push('📅 Optimal meeting schedule (+15)');
            } else if (dailyMeetingAverage <= 5) {
                score += 10;
                factors.push('📅 Good meeting balance (+10)');
            } else if (dailyMeetingAverage <= 7) {
                score += 5;
                factors.push('📅 Busy but manageable schedule (+5)');
            } else {
                factors.push('📅 Very busy meeting schedule (no bonus)');
            }
        }

        // Time-based bonus (10% of score)
        const currentHour = new Date().getHours();
        if (currentHour >= 9 && currentHour <= 17) {
            score += 10;
            factors.push('⏰ Active during business hours (+10)');
        }

        // Cap the score at 100
        score = Math.min(100, Math.max(0, score));

        // Update the productivity score in the UI
        const scoreElement = document.querySelector('.stat-card:last-child .stat-value');
        if (scoreElement) {
            scoreElement.textContent = `${score}%`;
            
            // Update the trend based on score
            const trendElement = scoreElement.parentElement.querySelector('.stat-trend span:last-child');
            if (trendElement) {
                if (score >= 80) {
                    trendElement.textContent = '+8% this week';
                    trendElement.style.color = '#28a745';
                } else if (score >= 60) {
                    trendElement.textContent = '+3% this week';
                    trendElement.style.color = '#ffc107';
                } else {
                    trendElement.textContent = '-2% this week';
                    trendElement.style.color = '#dc3545';
                }
            }
        }

        console.log('🎯 Productivity score calculated:', {
            score: score,
            factors: factors
        });

        // Store score for potential tooltip or detail view
        window.productivityFactors = factors;
        
    } catch (error) {
        console.error('Error calculating productivity score:', error);
        // Fallback to default if calculation fails
        const scoreElement = document.querySelector('.stat-card:last-child .stat-value');
        if (scoreElement) {
            scoreElement.textContent = '75%';
        }
    }
}

        // Utility functions for formatting responses
        function formatResponse(text) {
            let html = text;
            
            // Convert headers
            html = html.replace(/^### (.*$)/gm, '<h3 style="color: #667eea; margin: 1rem 0 0.5rem 0;">$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2 style="color: #333; margin: 1.5rem 0 0.5rem 0;">$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1 style="color: #333; margin: 1.5rem 0 0.5rem 0;">$1</h1>');
            
            // Convert bold text
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #495057;">$1</strong>');
            
            // Convert bullet points
            html = html.replace(/^[-•] (.*$)/gm, '<li style="margin: 0.25rem 0;">$1</li>');
            html = html.replace(/(<li>.*<\/li>)/gs, '<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">$1</ul>');
            
            // Convert line breaks
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            html = html.replace(/<p><\/p>/g, '');
            
            return html;
        }

        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = 
                '<div style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div><p style="margin-top: 1rem; color: #666;">Processing your request...</p></div>';
        }

        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = 
                `<div class="status-message status-error"><span>❌</span> ${message}</div>`;
        }

        function showSuccess(elementId, message) {
            document.getElementById(elementId).innerHTML = 
                `<div class="status-message status-success"><span>✅</span> ${message}</div>`;
        }


// Overview section functions - FIXED to use correct APIs
async function quickQuery(query) {
    showLoading('overview-response');
    
    try {
        // Determine if this is a calendar or email query and route appropriately
        const isCalendarQuery = query.toLowerCase().includes('calendar') || 
                               query.toLowerCase().includes('meeting') || 
                               query.toLowerCase().includes('schedule') ||
                               query.toLowerCase().includes('availability') ||
                               query.toLowerCase().includes('tomorrow') ||
                               query.toLowerCase().includes('today\'s schedule');
        
        let response;
        
        if (isCalendarQuery) {
            // Use calendar analysis API for calendar-related queries
            response = await fetch('/api/calendar/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
        } else {
            // Use email query API for email-related queries
            response = await fetch('/api/emails/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query, includeDays: 7 })
            });
        }

        if (response.ok) {
            const data = await response.json();
            const responseText = data.analysis || data.response;
            document.getElementById('overview-response').innerHTML = formatResponse(responseText);
        } else {
            const errorData = await response.json();
            showError('overview-response', errorData.message || 'Failed to process query');
        }
    } catch (error) {
        console.error('Error processing query:', error);
        showError('overview-response', 'Failed to connect to AI service');
    }
}

// ENHANCED: Tomorrow's availability function
async function checkTomorrowAvailability() {
    showLoading('overview-response');
    
    try {
        // Calculate tomorrow's date
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowDateString = tomorrow.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        console.log('🕒 Checking availability for:', tomorrowDateString);
        
        // Get tomorrow's calendar events
        const calendarResponse = await fetch('/api/calendar/events?days=2'); // Get today and tomorrow
        
        if (calendarResponse.ok) {
            const calendarData = await calendarResponse.json();
            
            // Filter events for tomorrow only
            const tomorrowEvents = calendarData.events.filter(event => {
                const eventDate = new Date(event.start.dateTime).toDateString();
                return eventDate === tomorrow.toDateString();
            });
            
            // Use AI to analyze availability
            const availabilityQuery = `Analyze my calendar for tomorrow (${tomorrowDateString}) and provide:

1. **Available Time Slots**: List specific time blocks that are free for meetings (at least 30 minutes)
2. **Existing Meetings**: Summary of scheduled meetings
3. **Best Times for**: Different types of activities (calls, deep work, meetings)
4. **Recommendations**: Optimal scheduling suggestions

Tomorrow's Events:
${tomorrowEvents.map(event => {
    const start = new Date(event.start.dateTime);
    const end = new Date(event.end.dateTime);
    return `- ${event.subject}: ${start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })} - ${end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
}).join('\n')}

Current time: ${new Date().toLocaleString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric', 
    hour: 'numeric', 
    minute: '2-digit', 
    hour12: true 
})}`;

            // Send to calendar analysis API
            const analysisResponse = await fetch('/api/calendar/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: availabilityQuery })
            });
            
            if (analysisResponse.ok) {
                const analysisData = await analysisResponse.json();
                
                // Format the response with additional context
                let responseHtml = formatResponse(analysisData.analysis);
                responseHtml += `
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-left: 3px solid #17a2b8; border-radius: 4px;">
                        <strong>📊 Quick Stats for Tomorrow:</strong><br>
                        <small style="color: #666;">
                            • ${tomorrowEvents.length} scheduled meetings<br>
                            • ${tomorrowEvents.length > 0 ? 'Busy day' : 'Light schedule'} - ${tomorrowEvents.length === 0 ? 'Great for focused work!' : 'Plan accordingly'}<br>
                            • Analysis based on ${calendarData.count} total calendar events
                        </small>
                    </div>
                `;
                
                document.getElementById('overview-response').innerHTML = responseHtml;
            } else {
                showError('overview-response', 'Failed to analyze availability');
            }
        } else {
            showError('overview-response', 'Failed to load calendar data');
        }
    } catch (error) {
        console.error('Error checking tomorrow\'s availability:', error);
        showError('overview-response', 'Failed to check availability');
    }
}

// ENHANCED: Today's schedule function
async function loadTodaySchedule() {
    showLoading('overview-response');
    
    try {
        const response = await fetch('/api/calendar/today');
        if (response.ok) {
            const data = await response.json();
            
            let scheduleHtml = `<h3 style="color: #667eea;">📅 Today's Schedule</h3>`;
            scheduleHtml += `<p><strong>${data.eventCount} meetings scheduled for ${data.date}</strong></p>`;
            
            if (data.events && data.events.length > 0) {
                scheduleHtml += '<div style="margin-top: 1rem;">';
                data.events.forEach((event, index) => {
                    const currentTime = new Date();
                    const eventStart = new Date(event.start.dateTime);
                    const eventEnd = new Date(event.end.dateTime);
                    
                    // Determine event status
                    let statusColor = '#667eea';
                    let statusText = '';
                    
                    if (currentTime > eventEnd) {
                        statusColor = '#28a745';
                        statusText = '✅ Completed';
                    } else if (currentTime >= eventStart && currentTime <= eventEnd) {
                        statusColor = '#dc3545';
                        statusText = '🔴 In Progress';
                    } else if (eventStart > currentTime) {
                        statusColor = '#ffc107';
                        statusText = '⏰ Upcoming';
                    }
                    
                    scheduleHtml += `
                        <div style="background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 8px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>${event.subject}</strong>
                                <small style="color: ${statusColor}; font-weight: bold;">${statusText}</small>
                            </div>
                            <span style="color: #666;">🕒 ${event.displayTime || 'Time not specified'}</span><br>
                            <span style="color: #666;">📍 ${event.location?.displayName || 'No location'}</span>
                        </div>
                    `;
                });
                scheduleHtml += '</div>';
            } else {
                scheduleHtml += '<p style="color: #28a745; margin-top: 1rem;">🎉 No meetings today! Great day for focused work.</p>';
            }
            
            // Add quick actions for today
            scheduleHtml += `
                <div style="margin-top: 1.5rem; padding: 1rem; background: #e8f4f8; border-radius: 8px;">
                    <strong>Quick Actions:</strong><br>
                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-outline" onclick="quickQuery('Find time for a quick call today')">📞 Quick Call</button>
                        <button class="btn btn-sm btn-outline" onclick="quickQuery('When is my next meeting?')">⏰ Next Meeting</button>
                        <button class="btn btn-sm btn-outline" onclick="quickQuery('Do I have any conflicts today?')">⚠️ Check Conflicts</button>
                    </div>
                </div>
            `;
            
            document.getElementById('overview-response').innerHTML = scheduleHtml;
        } else {
            showError('overview-response', 'Failed to load schedule');
        }
    } catch (error) {
        console.error('Error loading schedule:', error);
        showError('overview-response', 'Failed to load today\'s schedule');
    }
}

        // Email Analyzer functions
        async function analyzeEmails() {
            const query = document.getElementById('analyzer-query').value.trim();
            if (!query) {
                alert('Please enter a question about your emails');
                return;
            }

            showLoading('analyzer-response');
            
            try {
                const response = await fetch('/api/emails/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, includeDays: 7 })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('analyzer-response').innerHTML = formatResponse(data.response);
                } else {
                    const errorData = await response.json();
                    showError('analyzer-response', errorData.message || 'Failed to analyze emails');
                }
            } catch (error) {
                console.error('Error analyzing emails:', error);
                showError('analyzer-response', 'Failed to connect to AI service');
            }
        }

        function quickAnalyze(query) {
            document.getElementById('analyzer-query').value = query;
            analyzeEmails();
        }

        // REPLACE your existing loadEmailsForResponse function in dashboard.html with this enhanced version:

async function loadEmailsForResponse() {
    try {
        // Show loading state
        const loadButton = document.querySelector('button[onclick="loadEmailsForResponse()"]');
        const originalText = loadButton.textContent;
        loadButton.textContent = '📄 Loading Emails...';
        loadButton.disabled = true;
        
        // Load emails from past 7 days
        const response = await fetch('/api/emails?days=7');
        
        if (response.ok) {
            const data = await response.json();
            
            console.log('📧 Loaded emails for response:', {
                totalEmails: data.count,
                success: true
            });
            
            displayEmailList(data.emails);
            document.getElementById('email-list-container').style.display = 'block';
            
            // CRITICAL FIX: Remove ALL existing notifications with multiple selectors
            const emailListContainer = document.getElementById('email-list-container');
            
            // Remove by style attribute (green background)
            const existingByStyle = emailListContainer.querySelectorAll('div[style*="background: #d4edda"]');
            existingByStyle.forEach(element => element.remove());
            
            // Remove by class (if any have classes)
            const existingByClass = emailListContainer.querySelectorAll('.email-notification, .success-notification');
            existingByClass.forEach(element => element.remove());
            
            // Remove any div containing "Successfully loaded" text
            const allDivs = emailListContainer.querySelectorAll('div');
            allDivs.forEach(div => {
                if (div.textContent && div.textContent.includes('Successfully loaded') && div.textContent.includes('emails')) {
                    div.remove();
                }
            });
            
            // Add ONLY ONE new success summary with unique identifier
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'email-load-notification'; // Add class for easy removal
            summaryDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #c3e6cb;';
            summaryDiv.innerHTML = `
                <strong>✅ Successfully loaded ${data.count} emails</strong> from the past 7 days<br>
                <small style="color: #666;">
                    Ready to generate AI responses - select an email below
                </small>
            `;
            
            // Insert at the very beginning of the container
            if (emailListContainer.firstChild) {
                emailListContainer.insertBefore(summaryDiv, emailListContainer.firstChild);
            } else {
                emailListContainer.appendChild(summaryDiv);
            }
            
            // Restore button
            loadButton.textContent = originalText;
            loadButton.disabled = false;
            
        } else {
            // Only show error if there's actually an error
            const errorData = await response.json();
            console.error('❌ Error loading emails:', errorData);
            alert(`Error loading emails: ${errorData.message || 'Unknown error'}`);
            
            // Restore button
            loadButton.textContent = originalText;
            loadButton.disabled = false;
        }
    } catch (error) {
        // Only show error for actual network/connection errors
        console.error('❌ Network error loading emails:', error);
        alert(`Network error loading emails: ${error.message}`);
        
        // Restore button state
        const loadButton = document.querySelector('button[onclick="loadEmailsForResponse()"]');
        loadButton.textContent = '📧 Load Recent Emails';
        loadButton.disabled = false;
    }
}

    async function analyzeEmails() {
    const query = document.getElementById('analyzer-query').value.trim();
    if (!query) {
        alert('Please enter a question about your emails');
        return;
    }

    showLoading('analyzer-response');
    
    try {
        const response = await fetch('/api/emails/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                query, 
                includeDays: 14 // Analyze 14 days of emails for more comprehensive insights
            })
        });

        if (response.ok) {
            const data = await response.json();
            
            // Add analysis scope info to the response
            let responseHtml = formatResponse(data.response);
            responseHtml += `
                <div style="margin-top: 1.5rem; padding: 0.75rem; background: #f8f9fa; border-left: 3px solid #28a745; border-radius: 4px;">
                    <small style="color: #666;">
                        <strong>Analysis Scope:</strong> ${data.analysisScope}<br>
                        <strong>Query:</strong> "${data.query}"
                    </small>
                </div>
            `;
            
            document.getElementById('analyzer-response').innerHTML = responseHtml;
        } else {
            const errorData = await response.json();
            showError('analyzer-response', errorData.message || 'Failed to analyze emails');
        }
    } catch (error) {
        console.error('Error analyzing emails:', error);
        showError('analyzer-response', 'Failed to connect to AI service');
    }
}
// UPDATE your existing displayEmailList function to include checkboxes:
function displayEmailList(emails) {
    const emailList = document.getElementById('email-list');
    emailList.innerHTML = '';
    
    if (emails.length === 0) {
        emailList.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">No recent emails found</div>';
        return;
    }
    
    // Add "Select All" and "Move Selected" controls at the top
    const controlsDiv = document.createElement('div');
    controlsDiv.id = 'email-controls';
    controlsDiv.style.cssText = 'background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; justify-content: space-between;';
    controlsDiv.innerHTML = `
        <div style="display: flex; gap: 1rem; align-items: center;">
            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #333;">
                <input type="checkbox" id="select-all-emails" onchange="toggleAllEmails(this.checked)">
                Select All Emails
            </label>
            <span id="selected-count" style="color: #666; font-size: 0.9rem;">0 selected</span>
        </div>
        <button id="move-selected-btn" class="btn btn-secondary" onclick="moveSelectedToTrash()" disabled>
            📁 Move Selected to Deleted Items
        </button>
    `;
    emailList.appendChild(controlsDiv);
    
    // Add each email with checkbox
    emails.forEach(email => {
        const emailItem = document.createElement('div');
        emailItem.className = 'email-item';
        emailItem.dataset.emailId = email.id;
        
        const unreadBadge = !email.isRead ? '🔵 ' : '';
        const attachmentBadge = email.hasAttachments ? '📎 ' : '';
        
        emailItem.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <input type="checkbox" class="email-checkbox" value="${email.id}" onchange="updateSelectedCount()" style="margin-top: 0.5rem;">
                <div style="flex: 1; cursor: pointer;" onclick="selectEmail('${email.id}', this.closest('.email-item'), ${JSON.stringify(email).replace(/"/g, '&quot;')})">
                    <div class="email-subject">${unreadBadge}${attachmentBadge}${email.subject || 'No Subject'}</div>
                    <div class="email-from">From: ${email.from?.emailAddress?.name || email.from?.emailAddress?.address || 'Unknown'}</div>
                    <div class="email-preview">${email.bodyPreview || 'No preview available'}</div>
                    <div class="email-meta">
                        <span>${new Date(email.receivedDateTime).toLocaleDateString()}</span>
                        <span>${email.isRead ? 'Read' : 'Unread'}</span>
                    </div>
                </div>
            </div>
        `;
        
        emailList.appendChild(emailItem);
    });
}

// Function to toggle all email checkboxes
function toggleAllEmails(checked) {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = checked;
    });
    updateSelectedCount();
}

// Function to update the selected count and button state
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    const checkedBoxes = document.querySelectorAll('.email-checkbox:checked');
    
    const selectedCount = checkedBoxes.length;
    const totalCount = checkboxes.length;
    
    // Update count display
    document.getElementById('selected-count').textContent = `${selectedCount} selected`;
    
    // Update move button state
    const moveBtn = document.getElementById('move-selected-btn');
    moveBtn.disabled = selectedCount === 0;
    moveBtn.textContent = selectedCount > 0 ? `📁 Move ${selectedCount} to Deleted Items` : '📁 Move Selected to Deleted Items';
    
    // Update select all checkbox state
    const selectAllCheckbox = document.getElementById('select-all-emails');
    if (selectedCount === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (selectedCount === totalCount) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

// Function to move selected emails to trash
async function moveSelectedToTrash() {
    const checkedBoxes = document.querySelectorAll('.email-checkbox:checked');
    const selectedEmailIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    if (selectedEmailIds.length === 0) {
        alert('Please select emails to move to deleted items');
        return;
    }
    
    if (!confirm(`Move ${selectedEmailIds.length} selected emails to deleted items?`)) {
        return;
    }
    
    try {
        // Show loading state
        const moveBtn = document.getElementById('move-selected-btn');
        const originalText = moveBtn.textContent;
        moveBtn.innerHTML = '<span class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></span> Moving emails...';
        moveBtn.disabled = true;
        
        const response = await fetch('/api/emails/move-selected-to-trash', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ emailIds: selectedEmailIds })
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Remove moved emails from the UI with animation
            selectedEmailIds.forEach(emailId => {
                const emailElement = document.querySelector(`[data-email-id="${emailId}"]`);
                if (emailElement) {
                    emailElement.style.transition = 'all 0.3s ease';
                    emailElement.style.opacity = '0.5';
                    emailElement.style.transform = 'translateX(50px)';
                    
                    setTimeout(() => {
                        emailElement.remove();
                        updateSelectedCount();
                        
                        // Check if any emails are left
                        const remainingEmails = document.querySelectorAll('.email-item').length - 1; // -1 for controls div
                        if (remainingEmails === 0) {
                            document.getElementById('email-list').innerHTML = 
                                '<div style="padding: 2rem; text-align: center; color: #666;">No emails remaining</div>';
                        }
                    }, 300);
                }
            });
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'background: #d4edda; color: #155724; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #c3e6cb;';
            successMsg.innerHTML = `✅ ${data.message}`;
            document.getElementById('email-responder-section').insertBefore(successMsg, document.getElementById('email-list-container'));
            
            // Remove success message after 5 seconds
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.remove();
                }
            }, 5000);
            
            // Update stats
            loadStats();
            
        } else {
            const errorData = await response.json();
            alert(`Error: ${errorData.message || 'Failed to move emails to deleted items'}`);
        }
        
    } catch (error) {
        console.error('Error moving emails to trash:', error);
        alert('Failed to move emails to deleted items');
    } finally {
        // Restore button state
        const moveBtn = document.getElementById('move-selected-btn');
        updateSelectedCount(); // This will restore the proper button text and state
    }
}

        function selectEmail(emailId, element, emailData) {
            // Remove previous selection
            document.querySelectorAll('.email-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select current email
            element.classList.add('selected');
            selectedEmailId = emailId;
            
            // Show response form
            document.getElementById('response-form').style.display = 'block';
        }

        async function generateResponse() {
            if (!selectedEmailId) {
                alert('Please select an email first');
                return;
            }
            
            const context = document.getElementById('response-context').value;
            const tone = document.getElementById('response-tone').value;
            
            showLoading('response-content');
            document.getElementById('response-preview').style.display = 'block';
            
            try {
                console.log('🤖 Generating response for email:', selectedEmailId);
                
                const response = await fetch(`/api/emails/${selectedEmailId}/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ context, tone })
                });
                
                console.log('📥 Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Response generated successfully:', data);
                    
                    generatedResponse = data;
                    
                    // CLEANED UP: Removed blue notification and unnecessary details
                    document.getElementById('response-content').innerHTML = `
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #28a745;">
                            <h4 style="margin: 0 0 0.5rem; color: #155724;">🧵 Email Reply</h4>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">
                                <strong>Reply to:</strong> ${data.originalFrom}<br>
                                <strong>Subject:</strong> ${data.suggestedSubject}<br>
                                <strong>Type:</strong> Reply to maintain email thread
                            </p>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 2px solid #e1e5e9;">
                            <h4 style="margin-bottom: 1rem; color: #333;">Generated Response:</h4>
                            <div style="white-space: pre-wrap; line-height: 1.6;">${data.generatedResponse}</div>
                        </div>
                    `;
                    
                    // Show send buttons
                    document.getElementById('send-buttons').style.display = 'flex';
                } else {
                    const errorData = await response.json();
                    console.error('❌ Error generating response:', errorData);
                    document.getElementById('response-content').innerHTML = `
                        <div style="color: #d32f2f; background: #ffebee; padding: 1rem; border-radius: 8px;">
                            Error: ${errorData.message || errorData.error || 'Failed to generate response'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('❌ Network error generating response:', error);
                document.getElementById('response-content').innerHTML = `
                    <div style="color: #d32f2f; background: #ffebee; padding: 1rem; border-radius: 8px;">
                        Error: Failed to connect to AI service. Please check your connection and try again.
                    </div>
                `;
            }
        }
        
        async function sendResponse(replyToAll = false) {
            if (!generatedResponse) {
                alert('Please generate a response first');
                return;
            }
            
            const responseType = replyToAll ? 'Reply to All' : 'Reply';
            const sendBtn = document.querySelector(`button[onclick="sendResponse(${replyToAll})"]`);
            const originalText = sendBtn.textContent;
            sendBtn.textContent = `Sending ${responseType}...`;
            sendBtn.disabled = true;
            
            try {
                const endpoint = replyToAll ? 'reply-all' : 'send';
                const response = await fetch(`/api/emails/${selectedEmailId}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        responseContent: generatedResponse.generatedResponse,
                        subject: generatedResponse.suggestedSubject,
                        replyToAll: replyToAll
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // REMOVED: Blue notification bar - Show clean success message
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 1.5rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #c3e6cb;';
                    successDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 2rem;">✅</span>
                            <div>
                                <h4 style="margin: 0; color: #155724;">${responseType} Sent Successfully!</h4>
                                <p style="margin: 0.5rem 0 0; font-size: 0.9rem;">
                                    Your response was sent as a reply, maintaining the email thread.
                                </p>
                            </div>
                        </div>
                    `;
                    
                    // Insert success message
                    const responsePreview = document.getElementById('response-preview');
                    responsePreview.parentNode.insertBefore(successDiv, responsePreview);
                    
                    // Hide response form and reset
                    document.getElementById('response-form').style.display = 'none';
                    document.getElementById('response-preview').style.display = 'none';
                    
                    // Remove success message after 5 seconds
                    setTimeout(() => {
                        if (successDiv.parentNode) {
                            successDiv.remove();
                        }
                    }, 5000);
                    
                    // Update stats
                    if (typeof loadStats === 'function') {
                        loadStats();
                    }
                    
                } else {
                    const errorData = await response.json();
                    alert(`Error sending ${responseType.toLowerCase()}: ${errorData.message || 'Failed to send response'}`);
                }
            } catch (error) {
                console.error(`Error sending ${responseType.toLowerCase()}:`, error);
                alert(`Failed to send ${responseType.toLowerCase()}. Please try again.`);
            } finally {
                // Restore button
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
            }
        }

        function editResponse() {
            if (!generatedResponse) return;
            
            const responseText = generatedResponse.generatedResponse;
            document.getElementById('response-content').innerHTML = `
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>To:</strong> ${generatedResponse.originalFrom}<br>
                    <strong>Subject:</strong> ${generatedResponse.suggestedSubject}
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Edit Response:</label>
                    <textarea id="edit-response-text" class="form-textarea" style="min-height: 200px;">${responseText}</textarea>
                </div>
                <button class="btn btn-primary" onclick="updateResponse()">Update Response</button>
            `;
        }

        function updateResponse() {
            const newText = document.getElementById('edit-response-text').value;
            generatedResponse.generatedResponse = newText;
            
            document.getElementById('response-content').innerHTML = `
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>To:</strong> ${generatedResponse.originalFrom}<br>
                    <strong>Subject:</strong> ${generatedResponse.suggestedSubject}
                </div>
                <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 2px solid #e1e5e9;">
                    <h4 style="margin-bottom: 1rem; color: #333;">Updated Response:</h4>
                    <div style="white-space: pre-wrap; line-height: 1.6;">${newText}</div>
                </div>
            `;
        }

        function cancelResponse() {
            document.getElementById('response-form').style.display = 'none';
            document.getElementById('response-preview').style.display = 'none';
            document.getElementById('email-list-container').style.display = 'none';
            
            // Clear selections and reset
            document.querySelectorAll('.email-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            selectedEmailId = null;
            generatedResponse = null;
            
            // Clear form fields
            document.getElementById('response-context').value = '';
            document.getElementById('response-tone').value = 'professional';
        }

        // Calendar Manager functions
        async function analyzeCalendar() {
            const query = document.getElementById('calendar-query').value.trim();
            if (!query) {
                alert('Please enter a calendar query');
                return;
            }

            showLoading('calendar-response');
            
            try {
                const response = await fetch('/api/calendar/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('calendar-response').innerHTML = formatResponse(data.analysis);
                    
                    // Check for meeting suggestions
                    if (data.meetingData && data.meetingData.meetingDetected) {
                        showMeetingSuggestion(data.meetingData.meetingDetails);
                    }
                } else {
                    const errorData = await response.json();
                    showError('calendar-response', errorData.message || 'Failed to analyze calendar');
                }
            } catch (error) {
                console.error('Error analyzing calendar:', error);
                showError('calendar-response', 'Failed to analyze calendar');
            }
        }

        function quickCalendar(query) {
            document.getElementById('calendar-query').value = query;
            analyzeCalendar();
        }

        function showMeetingSuggestion(meetingDetails) {
            const suggestionHtml = `
                <div style="background: #e8f5e8; border: 2px solid #4caf50; border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                    <h4 style="color: #2e7d32; margin: 0 0 1rem 0;">🤖 AI Meeting Suggestion Detected!</h4>
                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p><strong>Meeting:</strong> ${meetingDetails.title}</p>
                        <p><strong>Duration:</strong> ${meetingDetails.duration} minutes</p>
                        <p><strong>Attendees:</strong> ${meetingDetails.attendees ? meetingDetails.attendees.join(', ') : 'None specified'}</p>
                        <p><strong>Type:</strong> ${meetingDetails.meetingType}</p>
                        <p><strong>Description:</strong> ${meetingDetails.description}</p>
                    </div>
                    <button class="btn btn-success" onclick="applyMeetingSuggestion()">📅 Apply Suggestion</button>
                    <button class="btn btn-outline" onclick="dismissSuggestion()" style="margin-left: 0.5rem;">❌ Dismiss</button>
                </div>
            `;
            
            document.getElementById('calendar-response').innerHTML += suggestionHtml;
            window.currentMeetingSuggestion = meetingDetails;
        }

        function applyMeetingSuggestion() {
            if (!window.currentMeetingSuggestion) return;
            
            const details = window.currentMeetingSuggestion;
            document.getElementById('meeting-title').value = details.title;
            document.getElementById('meeting-attendees').value = details.attendees ? details.attendees.join(', ') : '';
            document.getElementById('meeting-agenda').value = details.description;
            
            showMeetingForm();
        }

        function dismissSuggestion() {
            window.currentMeetingSuggestion = null;
            // Remove suggestion from DOM
            const suggestions = document.querySelectorAll('[style*="background: #e8f5e8"]');
            suggestions.forEach(s => s.remove());
        }

        function showMeetingForm() {
            document.getElementById('meeting-form').classList.add('active');
            
            // Set default times
            const now = new Date();
            const oneHour = new Date(now.getTime() + 60 * 60 * 1000);
            
            document.getElementById('meeting-start').value = now.toISOString().slice(0, 16);
            document.getElementById('meeting-end').value = oneHour.toISOString().slice(0, 16);
        }

        function hideMeetingForm() {
            document.getElementById('meeting-form').classList.remove('active');
            
            // Clear form
            document.getElementById('meeting-title').value = '';
            document.getElementById('meeting-attendees').value = '';
            document.getElementById('meeting-location').value = '';
            document.getElementById('meeting-agenda').value = '';
        }

        async function createMeeting() {
            const title = document.getElementById('meeting-title').value.trim();
            const startTime = document.getElementById('meeting-start').value;
            const endTime = document.getElementById('meeting-end').value;
            const attendeesStr = document.getElementById('meeting-attendees').value.trim();
            const location = document.getElementById('meeting-location').value.trim();
            const agenda = document.getElementById('meeting-agenda').value.trim();
            const meetingType = document.getElementById('meeting-type').value;
            
            if (!title || !startTime || !endTime) {
                alert('Please fill in the required fields (title, start time, end time)');
                return;
            }
            
            const attendees = attendeesStr ? attendeesStr.split(',').map(email => email.trim()).filter(email => email) : [];
            
            try {
                const response = await fetch('/api/calendar/create-invite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title, startTime: new Date(startTime).toISOString(),
                        endTime: new Date(endTime).toISOString(),
                        attendees, location, agenda, meetingType
                    })
                });
                
                if (response.ok) {
                    showSuccess('calendar-response', 'Meeting invite created successfully! 🎉');
                    hideMeetingForm();
                    loadStats();
                } else {
                    const errorData = await response.json();
                    showError('calendar-response', errorData.message || 'Failed to create meeting');
                }
            } catch (error) {
                console.error('Error creating meeting:', error);
                showError('calendar-response', 'Failed to create meeting invite');
            }
        }

        // AI Assistant functions
        async function askAI() {
            const query = document.getElementById('ai-query').value.trim();
            if (!query) {
                alert('Please enter a question for your AI assistant');
                return;
            }

            showLoading('ai-response');
            
            try {
                const response = await fetch('/api/emails/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, includeDays: 7 })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('ai-response').innerHTML = formatResponse(data.response);
                } else {
                    const errorData = await response.json();
                    showError('ai-response', errorData.message || 'Failed to process request');
                }
            } catch (error) {
                console.error('Error asking AI:', error);
                showError('ai-response', 'Failed to connect to AI assistant');
            }
        }

        function quickAI(query) {
            document.getElementById('ai-query').value = query;
            askAI();
        }

        // Settings functions
        function saveSettings() {
            const settings = {
                defaultTone: document.getElementById('default-tone').value,
                summaryFrequency: document.getElementById('summary-frequency').value,
                defaultDuration: document.getElementById('default-duration').value,
                preferredMeetingType: document.getElementById('preferred-meeting-type').value
            };
            
            localStorage.setItem('ai-email-agent-settings', JSON.stringify(settings));
            
            // Also save signature settings
            saveSignatureSettings();
            
            showSuccess('settings-section', 'All settings saved successfully! 💾');
        }

        function resetSettings() {
            document.getElementById('default-tone').value = 'professional';
            document.getElementById('summary-frequency').value = 'daily';
            document.getElementById('default-duration').value = '60';
            document.getElementById('preferred-meeting-type').value = 'teams';
            
            localStorage.removeItem('ai-email-agent-settings');
            showSuccess('settings-section', 'Settings reset to defaults');
        }

        // Load saved settings on page load
        function loadSettings() {
            const saved = localStorage.getItem('ai-email-agent-settings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('default-tone').value = settings.defaultTone || 'professional';
                document.getElementById('summary-frequency').value = settings.summaryFrequency || 'daily';
                document.getElementById('default-duration').value = settings.defaultDuration || '60';
                document.getElementById('preferred-meeting-type').value = settings.preferredMeetingType || 'teams';
            }
        }

        function updateSignaturePreview() {
            const name = document.getElementById('signature-name').value.trim();
            const title = document.getElementById('signature-title').value.trim();
            const company = document.getElementById('signature-company').value.trim();
            const phone = document.getElementById('signature-phone').value.trim();
            const email = document.getElementById('signature-email').value.trim();
            const website = document.getElementById('signature-website').value.trim();
            const additional = document.getElementById('signature-additional').value.trim();
            
            let preview = '';
            
            if (name) {
                preview += `<div style="font-weight: 600; color: #333;">${name}</div>`;
            }
            
            if (title) {
                preview += `<div style="color: #666; font-size: 0.9em;">${title}</div>`;
            }
            
            if (company) {
                preview += `<div style="color: #666; font-size: 0.9em;">${company}</div>`;
            }
            
            if (phone || email) {
                preview += '<div style="margin-top: 0.5rem;">';
                if (phone) preview += `<div>📞 ${phone}</div>`;
                if (email) preview += `<div>✉️ ${email}</div>`;
                preview += '</div>';
            }
            
            if (website) {
                preview += `<div style="margin-top: 0.3rem;">🌐 <a href="${website}" style="color: #667eea; text-decoration: none;">${website}</a></div>`;
            }
            
            if (additional) {
                preview += `<div style="margin-top: 0.5rem; font-size: 0.85em; color: #777;">${additional}</div>`;
            }
            
            if (!preview) {
                preview = '<em style="color: #999;">Fill in the fields above to see your signature preview...</em>';
            }
            
            document.getElementById('signature-preview').innerHTML = preview;
        }
        
        // Load signature settings from server
        async function loadSignatureSettings() {
            try {
                const response = await fetch('/api/settings/signature');
                if (response.ok) {
                    const data = await response.json();
                    if (data.signature) {
                        const signature = data.signature;
                        document.getElementById('signature-name').value = signature.name || '';
                        document.getElementById('signature-title').value = signature.title || '';
                        document.getElementById('signature-company').value = signature.company || '';
                        document.getElementById('signature-phone').value = signature.phone || '';
                        document.getElementById('signature-email').value = signature.email || '';
                        document.getElementById('signature-website').value = signature.website || '';
                        document.getElementById('signature-additional').value = signature.additional || '';
                        document.getElementById('signature-enabled').checked = signature.enabled !== false;
                        updateSignaturePreview();
                    }
                }
            } catch (error) {
                console.error('Error loading signature settings:', error);
            }
        }
        
        // Save signature settings to server
        async function saveSignatureSettings() {
            const signatureData = {
                name: document.getElementById('signature-name').value.trim(),
                title: document.getElementById('signature-title').value.trim(),
                company: document.getElementById('signature-company').value.trim(),
                phone: document.getElementById('signature-phone').value.trim(),
                email: document.getElementById('signature-email').value.trim(),
                website: document.getElementById('signature-website').value.trim(),
                additional: document.getElementById('signature-additional').value.trim(),
                enabled: document.getElementById('signature-enabled').checked
            };
            
            try {
                const response = await fetch('/api/settings/signature', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ signature: signatureData })
                });
                
                if (response.ok) {
                    showSuccess('settings-section', 'Email signature settings saved successfully! 📝');
                } else {
                    const errorData = await response.json();
                    showError('settings-section', errorData.message || 'Failed to save signature settings');
                }
            } catch (error) {
                console.error('Error saving signature settings:', error);
                showError('settings-section', 'Failed to save signature settings');
            }
        }
        
        // Add event listeners for real-time preview updates
        document.addEventListener('DOMContentLoaded', function() {
            // Add signature input listeners after a short delay to ensure elements exist
            setTimeout(() => {
                const signatureInputs = [
                    'signature-name', 'signature-title', 'signature-company',
                    'signature-phone', 'signature-email', 'signature-website', 'signature-additional'
                ];
                
                signatureInputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', updateSignaturePreview);
                    }
                });
                
                // Load signature settings on page load
                loadSignatureSettings();
            }, 500);
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
    // Enter key to submit forms (not just Ctrl/Cmd + Enter)
    if (e.key === 'Enter' && !e.shiftKey) {
        const activeElement = document.activeElement;
        
        // Calendar Manager - Enter key support
        if (activeElement.id === 'calendar-query') {
            e.preventDefault();
            analyzeCalendar();
            return;
        }
        
        // Email Analyzer - Enter key support  
        if (activeElement.id === 'analyzer-query') {
            e.preventDefault();
            analyzeEmails();
            return;
        }
        
        // Overview Quick Query - Enter key support
        if (activeElement.id === 'ai-query') {
            e.preventDefault();
            askAI();
            return;
        }
        
        // Email Response Context - Shift+Enter for new line, Enter to generate
        if (activeElement.id === 'response-context') {
            if (!e.shiftKey) {
                e.preventDefault();
                generateResponse();
                return;
            }
        }
    }
    
    // Ctrl/Cmd + Enter as alternative for all inputs
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const activeElement = document.activeElement;
        
        if (activeElement.id === 'analyzer-query') {
            analyzeEmails();
        } else if (activeElement.id === 'calendar-query') {
            analyzeCalendar();
        } else if (activeElement.id === 'ai-query') {
            askAI();
        } else if (activeElement.id === 'response-context') {
            generateResponse();
        }
    }
    
    // ESC key to cancel operations
    if (e.key === 'Escape') {
        // Cancel email response if open
        if (document.getElementById('response-form').style.display !== 'none') {
            cancelResponse();
        }
    }
});

// Add visual feedback when inputs are focused
document.addEventListener('DOMContentLoaded', function() {
    // Add placeholder hints about Enter key
    const calendarInput = document.getElementById('calendar-query');
    const analyzerInput = document.getElementById('analyzer-query');
    const overviewInput = document.getElementById('ai-query');
    
    if (calendarInput) {
        calendarInput.placeholder = 'Ask about your calendar... (Press Enter to analyze)';
        addInputFeedback(calendarInput);
    }
    
    if (analyzerInput) {
        analyzerInput.placeholder = 'Ask about your emails... (Press Enter to analyze)';
        addInputFeedback(analyzerInput);
    }
    
    if (overviewInput) {
        overviewInput.placeholder = 'Ask me anything about your emails or calendar... (Press Enter to ask)';
        addInputFeedback(overviewInput);
    }
});

// Helper function to add visual feedback to inputs
function addInputFeedback(input) {
    if (!input) return;
    
    input.addEventListener('focus', function() {
        this.style.borderColor = '#667eea';
        this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
    });
    
    input.addEventListener('blur', function() {
        this.style.borderColor = '#e1e5e9';
        this.style.boxShadow = 'none';
    });
    
    // Add subtle animation when typing
    input.addEventListener('input', function() {
        if (this.value.length > 0) {
            this.style.backgroundColor = '#f8f9ff';
        } else {
            this.style.backgroundColor = '#ffffff';
        }
    });
}

        // Auto-refresh stats every 5 minutes
        setInterval(loadStats, 5 * 60 * 1000);

        // Load settings when page loads
        setTimeout(loadSettings, 100);
    </script>
</body>
</html>
